<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Gestión de Transacciones - Sistema Tributario</title>
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <link rel="stylesheet" th:href="@{/css/fullscreen-layout.css}">
    <link rel="stylesheet" th:href="@{/css/buttons-professional.css}">
    <link rel="stylesheet" th:href="@{/css/icons.css}">
    <script th:src="@{/js/theme.js}"></script>
    
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .detail-group {
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .detail-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            color: #495057;
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.4;
        }
        
        /* Estilos para modo oscuro */
        body:not(.light-mode) .detail-label {
            color: #a4a4be;
        }
        
        body:not(.light-mode) .detail-value {
            color: #e7e7f7;
        }
        
        body:not(.light-mode) .detail-group {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Spinner para indicador de carga */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mejoras para formularios */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        body:not(.light-mode) .form-label {
            color: #e7e7f7;
        }
        
        .form-control:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25);
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid transparent;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        body:not(.light-mode) .alert-info {
            background-color: rgba(23, 162, 184, 0.1);
            border-color: rgba(23, 162, 184, 0.3);
            color: #17a2b8;
        }
    </style>
</head>
<body>
<div class="fullscreen-container">
    <!-- Efectos decorativos -->
    <div class="fullscreen-effects">
        <div class="fullscreen-splash1"></div>
        <div class="fullscreen-splash2"></div>
        <div class="fullscreen-splash3"></div>
    </div>
    
    <!-- Navegación -->
    <aside th:replace="fragments/nav :: body"></aside>
    
    <!-- Contenido principal -->
    <main class="fullscreen-main">
        <!-- Header -->
        <div class="fullscreen-header">
            <h2 style="margin:0;color:#e2e8f0;font-size:24px;font-weight:700;display:flex;align-items:center;gap:12px">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="page-title-icon">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                Gestión de Transacciones
            </h2>
            <div style="display:flex;align-items:center;gap:16px">
                <button class="btn-modern btn-modern-success" sec:authorize="hasAnyAuthority('TRANSACCIONES_WRITE','TRANSACCIONES_GESTIONAR')" onclick="abrirModalCrear()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nueva Transacción
                </button>
                <button class="btn-modern btn-modern-export" onclick="exportarTransacciones()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exportar
                </button>
                <button class="btn-modern btn-modern-info" onclick="recargarTabla()" title="Actualizar datos">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <polyline points="23 4 23 10 17 10"/>
                        <polyline points="1 20 1 14 7 14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                    Actualizar
                </button>
            </div>
        </div>
        
        <!-- Contenido con scroll -->
        <div class="fullscreen-content">
            <!-- Estadísticas rápidas -->
            <div class="fullscreen-stats">
                <div class="stat-card" style="border-left:4px solid #8b5cf6">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Total Transacciones</div>
                    <div style="font-size:32px;font-weight:700;color:#8b5cf6" th:text="${estadisticas?.totalTransacciones ?: 0}">0</div>
                </div>
                
                <div class="stat-card" style="border-left:4px solid #f59e0b">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Pendientes</div>
                    <div style="font-size:32px;font-weight:700;color:#f59e0b" th:text="${estadisticas?.transaccionesPendientes ?: 0}">0</div>
                </div>
                
                <div class="stat-card" style="border-left:4px solid #10b981">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Procesadas</div>
                    <div style="font-size:32px;font-weight:700;color:#10b981" th:text="${estadisticas?.transaccionesProcesadas ?: 0}">0</div>
                </div>
                
                <div class="stat-card" style="border-left:4px solid #06b6d4">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Confirmadas</div>
                    <div style="font-size:32px;font-weight:700;color:#06b6d4" th:text="${estadisticas?.transaccionesConfirmadas ?: 0}">0</div>
                </div>
            </div>

            <!-- Tabla de transacciones -->
            <div class="fullscreen-table-container">
                <div style="padding:20px;border-bottom:1px solid rgba(148, 163, 184, 0.2)">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:#e2e8f0;font-size:18px;font-weight:600">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:middle">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            Lista de Transacciones
                        </h3>
                        <div style="display:flex;gap:12px;align-items:center">
                            <input type="text" placeholder="Buscar transacción..." class="form-control" style="width:200px;background:rgba(15, 23, 42, 0.6);border:1px solid rgba(148, 163, 184, 0.3);color:#e2e8f0" id="buscarTransaccion">
                            <select class="form-select" style="width:150px;background:rgba(15, 23, 42, 0.6);border:1px solid rgba(148, 163, 184, 0.3);color:#e2e8f0" id="filtroEstado">
                                <option value="">Todos los estados</option>
                                <option value="PENDIENTE">Pendientes</option>
                                <option value="PROCESANDO">Procesando</option>
                                <option value="PROCESADA">Procesadas</option>
                                <option value="CONFIRMADA">Confirmadas</option>
                                <option value="ANULADA">Anuladas</option>
                                <option value="RECHAZADA">Rechazadas</option>
                            </select>
                            <select class="form-select" style="width:150px;background:rgba(15, 23, 42, 0.6);border:1px solid rgba(148, 163, 184, 0.3);color:#e2e8f0" id="filtroTipo">
                                <option value="">Todos los tipos</option>
                                <option value="INGRESO">Ingresos</option>
                                <option value="EGRESO">Egresos</option>
                                <option value="PAGO_SERVICIO">Pago Servicio</option>
                                <option value="PAGO_IMPUESTO">Pago Impuesto</option>
                                <option value="PAGO_TASA">Pago Tasa</option>
                                <option value="PAGO_MULTA">Pago Multa</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="overflow-y:auto;max-height:calc(100vh - 320px)">
                    <table class="fullscreen-table">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Tipo</th>
                                <th>Contribuyente</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transaccionesTable">
                            <tr th:each="transaccion : ${transacciones.content}" th:if="${transacciones?.content?.size() > 0}">
                                <td><strong th:text="${transaccion.numeroTransaccion}">TXN-2025-12345678</strong></td>
                                <td>
                                    <span class="badge badge-primary" th:text="${transaccion.tipoTransaccionDescripcion}">Ingreso</span>
                                </td>
                                <td>
                                    <div style="font-weight:500" th:text="${transaccion.contribuyenteNombre ?: 'N/A'}">Juan Pérez</div>
                                    <div class="text-muted" style="font-size:12px" th:text="${transaccion.contribuyenteRif ?: ''}">V-12345678-9</div>
                                </td>
                                <td><strong th:text="'$' + ${#numbers.formatDecimal(transaccion.monto, 1, 2)}">$1,250.00</strong></td>
                                <td>
                                    <span class="badge" 
                                          th:classappend="${transaccion.estado.name() == 'CONFIRMADA'} ? 'badge-success' : 
                                                         (${transaccion.estado.name() == 'PROCESADA'} ? 'badge-info' : 
                                                         (${transaccion.estado.name() == 'PENDIENTE'} ? 'badge-warning' : 
                                                         (${transaccion.estado.name() == 'ANULADA'} ? 'badge-danger' : 'badge-secondary')))"
                                          th:text="${transaccion.estadoDescripcion}">Confirmada</span>
                                </td>
                                <td th:text="${transaccion.fechaTransaccion != null ? #temporals.format(transaccion.fechaTransaccion, 'dd/MM/yyyy HH:mm') : 'N/A'}">01/10/2025 10:30</td>
                                <td>
                                    <div style="display:flex;gap:8px">
                                        <!-- Ver transacción -->
                                        <button class="btn btn-sm btn-info" 
                                                th:onclick="'verTransaccion(' + ${transaccion.id} + ')'"
                                                sec:authorize="hasAnyAuthority('TRANSACCIONES_READ', 'TRANSACCIONES_WRITE', 'TRANSACCIONES_GESTIONAR')">
                                            👁️
                                        </button>
                                        
                                        <!-- Editar transacción -->
                                        <button class="btn btn-sm btn-secondary" 
                                                th:onclick="'editarTransaccion(' + ${transaccion.id} + ')'"
                                                th:if="${transaccion.estado.name() == 'PENDIENTE'}"
                                                sec:authorize="hasAnyAuthority('TRANSACCIONES_WRITE', 'TRANSACCIONES_GESTIONAR')">
                                            ✏️
                                        </button>
                                        
                                        <!-- Procesar transacción -->
                                        <button class="btn btn-sm btn-warning" 
                                                th:onclick="'procesarTransaccion(' + ${transaccion.id} + ')'"
                                                th:if="${transaccion.estado.name() == 'PENDIENTE'}"
                                                sec:authorize="hasAnyAuthority('TRANSACCIONES_WRITE', 'TRANSACCIONES_GESTIONAR')">
                                            ⚡
                                        </button>
                                        
                                        <!-- Confirmar transacción -->
                                        <button class="btn btn-sm btn-success" 
                                                th:onclick="'confirmarTransaccion(' + ${transaccion.id} + ')'"
                                                th:if="${transaccion.estado.name() == 'PROCESADA'}"
                                                sec:authorize="hasAnyAuthority('TRANSACCIONES_WRITE', 'TRANSACCIONES_GESTIONAR')">
                                            ✅
                                        </button>
                                        
                                        <!-- Anular transacción -->
                                        <button class="btn btn-sm btn-danger" 
                                                th:onclick="'anularTransaccion(' + ${transaccion.id} + ')'"
                                                th:if="${transaccion.estado.name() != 'ANULADA'}"
                                                sec:authorize="hasAnyAuthority('TRANSACCIONES_GESTIONAR')">
                                            ❌
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${transacciones?.content?.size() == 0}">
                                <td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:16px;opacity:0.5">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                        <path d="M2 17l10 5 10-5"/>
                                        <path d="M2 12l10 5 10-5"/>
                                    </svg>
                                    <br>No hay transacciones registradas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Elementos decorativos -->
    <div class="brand">Sistema Tributario Empresarial v2.0</div>
    <div class="splash"></div>
    <div class="splash2"></div>
    <div class="splash3"></div>
</div>

<!-- Incluir modales -->
<div th:replace="fragments/modals :: body"></div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    
// Variables globales
let transaccionesData = [];
let contribuyentesData = [];

// Token CSRF
const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

// Headers comunes para peticiones
function getHeaders() {
    const headers = {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
    };
    if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
    }
    return headers;
}

// Función para mostrar/ocultar indicador de carga
function showLoading(show) {
    const buttons = document.querySelectorAll('.modal-submit, .btn-modern');
    buttons.forEach(btn => {
        if (show) {
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
        } else {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        }
    });
    
    // Mostrar spinner en el botón principal del modal
    const submitBtn = document.querySelector('.modal-submit');
    if (submitBtn) {
        if (show) {
            submitBtn.innerHTML = '<span class="spinner"></span> Procesando...';
        } else {
            submitBtn.innerHTML = 'Guardar';
        }
    }
}

// Función para mostrar notificaciones toast
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    if (!container) {
        console.error('No se encontró el contenedor de toast');
        return;
    }
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-out;
        min-width: 300px;
        font-weight: 500;
    `;
    
    const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️';
    toast.innerHTML = `
        <span style="font-size:16px">${icon}</span>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 4000);
}

// Funciones CRUD completas
function verTransaccion(id) {
    showLoading(true);
    fetch(`/transacciones/api/${id}`, {
        headers: getHeaders()
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(transaccion => {
        const modalTitle = `
            <div style="display:flex;align-items:center;gap:8px">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#17a2b8">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                </svg>
                Detalles de Transacción: ${transaccion.numeroTransaccion}
            </div>
        `;
        
        const detalles = getDetallesTransaccionHTML(transaccion);
        openModal(modalTitle, detalles, null);
        showLoading(false);
    })
    .catch(error => {
        console.error('Error:', error);
        showLoading(false);
        showToast('Error al cargar los detalles de la transacción: ' + error.message, 'error');
    });
}

function editarTransaccion(id) {
    showLoading(true);
    fetch(`/transacciones/api/${id}`, {
        headers: getHeaders()
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(transaccion => {
        const modalTitle = `
            <div style="display:flex;align-items:center;gap:8px">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#ffc107">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Editar Transacción: ${transaccion.numeroTransaccion}
            </div>
        `;
        
        const editarContent = getFormularioTransaccionHTML(transaccion);
        openModal(modalTitle, editarContent, () => actualizarTransaccion(id));
        
        // Cargar contribuyentes después de un pequeño delay
        setTimeout(() => {
            cargarContribuyentes();
            if (transaccion.contribuyenteId) {
                document.getElementById('editContribuyenteId').value = transaccion.contribuyenteId;
            }
        }, 100);
        showLoading(false);
    })
    .catch(error => {
        console.error('Error:', error);
        showLoading(false);
        showToast('Error al cargar los datos de la transacción: ' + error.message, 'error');
    });
}

function procesarTransaccion(id) {
    if (confirm('¿Está seguro de que desea procesar esta transacción?')) {
        showLoading(true);
        fetch(`/transacciones/api/${id}/procesar`, {
            method: 'POST',
            headers: getHeaders()
        })
        .then(response => {
            if (response.ok) {
                showLoading(false);
                actualizarSinRecargar('Transacción procesada exitosamente');
            } else {
                return response.text().then(text => {
                    let errorMsg = 'Error al procesar la transacción';
                    try {
                        const errorObj = JSON.parse(text);
                        errorMsg = errorObj.error || errorObj.message || errorMsg;
                    } catch (e) {
                        errorMsg = text || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showLoading(false);
            showToast('Error al procesar transacción: ' + error.message, 'error');
        });
    }
}

function confirmarTransaccion(id) {
    if (confirm('¿Está seguro de que desea confirmar esta transacción?')) {
        showLoading(true);
        fetch(`/transacciones/api/${id}/confirmar`, {
            method: 'POST',
            headers: getHeaders()
        })
        .then(response => {
            if (response.ok) {
                showLoading(false);
                actualizarSinRecargar('Transacción confirmada exitosamente');
            } else {
                return response.text().then(text => {
                    let errorMsg = 'Error al confirmar la transacción';
                    try {
                        const errorObj = JSON.parse(text);
                        errorMsg = errorObj.error || errorObj.message || errorMsg;
                    } catch (e) {
                        errorMsg = text || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showLoading(false);
            showToast('Error al confirmar transacción: ' + error.message, 'error');
        });
    }
}

function anularTransaccion(id) {
    const motivo = prompt('Ingrese el motivo de anulación:');
    if (motivo && motivo.trim()) {
        showLoading(true);
        fetch(`/transacciones/api/${id}/anular?motivo=${encodeURIComponent(motivo)}`, {
            method: 'POST',
            headers: getHeaders()
        })
        .then(response => {
            if (response.ok) {
                showLoading(false);
                actualizarSinRecargar('Transacción anulada exitosamente');
            } else {
                return response.text().then(text => {
                    let errorMsg = 'Error al anular la transacción';
                    try {
                        const errorObj = JSON.parse(text);
                        errorMsg = errorObj.error || errorObj.message || errorMsg;
                    } catch (e) {
                        errorMsg = text || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showLoading(false);
            showToast('Error al anular transacción: ' + error.message, 'error');
        });
    }
}

function abrirModalCrear() {
    const modalTitle = `
        <div style="display:flex;align-items:center;gap:8px">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#28a745">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Nueva Transacción
        </div>
    `;
    
    const crearContent = getFormularioTransaccionHTML();
    openModal(modalTitle, crearContent, crearTransaccion);
    
    // Cargar contribuyentes
    setTimeout(cargarContribuyentes, 100);
}

function exportarTransacciones() {
    // Crear datos para exportar
    const transacciones = [];
    const filas = document.querySelectorAll('.fullscreen-table tbody tr');
    
    filas.forEach(fila => {
        if (fila.cells.length >= 7 && fila.style.display !== 'none') {
            transacciones.push({
                numero: fila.cells[0].textContent.trim(),
                tipo: fila.cells[1].textContent.trim(),
                contribuyente: fila.cells[2].textContent.trim(),
                monto: fila.cells[3].textContent.trim(),
                estado: fila.cells[4].textContent.trim(),
                fecha: fila.cells[5].textContent.trim()
            });
        }
    });
    
    if (transacciones.length === 0) {
        showToast('No hay transacciones para exportar', 'error');
        return;
    }
    
    // Crear CSV
    let csv = 'Número,Tipo,Contribuyente,Monto,Estado,Fecha\n';
    transacciones.forEach(transaccion => {
        csv += `"${transaccion.numero}","${transaccion.tipo}","${transaccion.contribuyente}","${transaccion.monto}","${transaccion.estado}","${transaccion.fecha}"\n`;
    });
    
    // Descargar archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `transacciones_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Archivo exportado exitosamente', 'success');
}

function recargarTabla() {
    fetch('/transacciones', {
        headers: getHeaders()
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text();
    })
    .then(html => {
        // Crear un documento temporal para extraer solo la tabla
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const nuevaTabla = doc.querySelector('.fullscreen-table tbody');
        const nuevasEstadisticas = doc.querySelectorAll('.stat-card');
        
        if (nuevaTabla) {
            // Actualizar tabla
            const tablaActual = document.querySelector('.fullscreen-table tbody');
            if (tablaActual) {
                tablaActual.innerHTML = nuevaTabla.innerHTML;
            }
        }
        
        if (nuevasEstadisticas.length > 0) {
            // Actualizar estadísticas
            const estadisticasActuales = document.querySelectorAll('.stat-card');
            nuevasEstadisticas.forEach((nueva, index) => {
                if (estadisticasActuales[index]) {
                    estadisticasActuales[index].innerHTML = nueva.innerHTML;
                }
            });
        }
        
        showToast('Datos actualizados correctamente', 'success');
    })
    .catch(error => {
        console.error('Error al recargar datos:', error);
        // En lugar de mostrar error, hacer un refresh completo como fallback
        console.log('Intentando recarga completa de página...');
        setTimeout(() => {
            location.reload();
        }, 1000);
    });
}

// Funciones auxiliares para formularios y modales
function getDetallesTransaccionHTML(transaccion) {
    return `
        <div class="row">
            <div class="col-md-6">
                <div class="detail-group mb-3">
                    <label class="detail-label">Número de Transacción:</label>
                    <div class="detail-value">${transaccion.numeroTransaccion}</div>
                </div>
                <div class="detail-group mb-3">
                    <label class="detail-label">Tipo de Transacción:</label>
                    <div class="detail-value">${transaccion.tipoTransaccionDescripcion}</div>
                </div>
                <div class="detail-group mb-3">
                    <label class="detail-label">Estado:</label>
                    <div class="detail-value">
                        <span class="badge badge-${transaccion.estado.toLowerCase()}">${transaccion.estadoDescripcion}</span>
                    </div>
                </div>
                <div class="detail-group mb-3">
                    <label class="detail-label">Monto:</label>
                    <div class="detail-value">$${transaccion.monto.toFixed(2)}</div>
                </div>
                ${transaccion.contribuyenteNombre ? `
                <div class="detail-group mb-3">
                    <label class="detail-label">Contribuyente:</label>
                    <div class="detail-value">${transaccion.contribuyenteNombre}</div>
                    <small class="text-muted">${transaccion.contribuyenteRif}</small>
                </div>
                ` : ''}
            </div>
            <div class="col-md-6">
                <div class="detail-group mb-3">
                    <label class="detail-label">Fecha de Transacción:</label>
                    <div class="detail-value">${new Date(transaccion.fechaTransaccion).toLocaleString()}</div>
                </div>
                ${transaccion.fechaProcesamiento ? `
                <div class="detail-group mb-3">
                    <label class="detail-label">Fecha de Procesamiento:</label>
                    <div class="detail-value">${new Date(transaccion.fechaProcesamiento).toLocaleString()}</div>
                </div>
                ` : ''}
                ${transaccion.fechaConfirmacion ? `
                <div class="detail-group mb-3">
                    <label class="detail-label">Fecha de Confirmación:</label>
                    <div class="detail-value">${new Date(transaccion.fechaConfirmacion).toLocaleString()}</div>
                </div>
                ` : ''}
                ${transaccion.referenciaExterna ? `
                <div class="detail-group mb-3">
                    <label class="detail-label">Referencia Externa:</label>
                    <div class="detail-value">${transaccion.referenciaExterna}</div>
                </div>
                ` : ''}
                ${transaccion.numeroComprobante ? `
                <div class="detail-group mb-3">
                    <label class="detail-label">Número de Comprobante:</label>
                    <div class="detail-value">${transaccion.numeroComprobante}</div>
                </div>
                ` : ''}
                ${transaccion.usuarioRegistro ? `
                <div class="detail-group mb-3">
                    <label class="detail-label">Usuario de Registro:</label>
                    <div class="detail-value">${transaccion.usuarioRegistro}</div>
                </div>
                ` : ''}
            </div>
        </div>
        ${transaccion.concepto ? `
        <div class="detail-group mb-3">
            <label class="detail-label">Concepto:</label>
            <div class="detail-value">${transaccion.concepto}</div>
        </div>
        ` : ''}
        ${transaccion.observaciones ? `
        <div class="detail-group mb-3">
            <label class="detail-label">Observaciones:</label>
            <div class="detail-value">${transaccion.observaciones}</div>
        </div>
        ` : ''}
    `;
}

function getFormularioTransaccionHTML(transaccion = null) {
    const isEdit = transaccion !== null;
    return `
        <div class="alert alert-info mb-3">
            <strong>Información:</strong> ${isEdit ? 'Solo se pueden editar transacciones en estado PENDIENTE.' : 'El número de transacción se generará automáticamente.'}
        </div>
        <form id="transaccionForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">Tipo de Transacción *</label>
                        <select name="tipoTransaccion" class="form-control" required>
                            <option value="">Seleccione un tipo</option>
                            <option value="INGRESO" ${isEdit && transaccion.tipoTransaccion === 'INGRESO' ? 'selected' : ''}>Ingreso</option>
                            <option value="EGRESO" ${isEdit && transaccion.tipoTransaccion === 'EGRESO' ? 'selected' : ''}>Egreso</option>
                            <option value="PAGO_SERVICIO" ${isEdit && transaccion.tipoTransaccion === 'PAGO_SERVICIO' ? 'selected' : ''}>Pago de Servicio</option>
                            <option value="PAGO_IMPUESTO" ${isEdit && transaccion.tipoTransaccion === 'PAGO_IMPUESTO' ? 'selected' : ''}>Pago de Impuesto</option>
                            <option value="PAGO_TASA" ${isEdit && transaccion.tipoTransaccion === 'PAGO_TASA' ? 'selected' : ''}>Pago de Tasa</option>
                            <option value="PAGO_MULTA" ${isEdit && transaccion.tipoTransaccion === 'PAGO_MULTA' ? 'selected' : ''}>Pago de Multa</option>
                            <option value="TRANSFERENCIA" ${isEdit && transaccion.tipoTransaccion === 'TRANSFERENCIA' ? 'selected' : ''}>Transferencia</option>
                            <option value="DEVOLUCION" ${isEdit && transaccion.tipoTransaccion === 'DEVOLUCION' ? 'selected' : ''}>Devolución</option>
                            <option value="AJUSTE" ${isEdit && transaccion.tipoTransaccion === 'AJUSTE' ? 'selected' : ''}>Ajuste</option>
                            <option value="COMISION" ${isEdit && transaccion.tipoTransaccion === 'COMISION' ? 'selected' : ''}>Comisión</option>
                            <option value="INTERES" ${isEdit && transaccion.tipoTransaccion === 'INTERES' ? 'selected' : ''}>Interés</option>
                            <option value="DESCUENTO" ${isEdit && transaccion.tipoTransaccion === 'DESCUENTO' ? 'selected' : ''}>Descuento</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Monto *</label>
                        <input type="number" step="0.01" name="monto" class="form-control" 
                               value="${isEdit ? transaccion.monto : ''}" required min="0.01">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Contribuyente</label>
                        <select id="editContribuyenteId" name="contribuyenteId" class="form-control">
                            <option value="">Seleccione un contribuyente (opcional)</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Referencia Externa</label>
                        <input type="text" name="referenciaExterna" class="form-control" 
                               value="${isEdit ? (transaccion.referenciaExterna || '') : ''}" 
                               placeholder="Referencia del sistema externo">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">Concepto *</label>
                        <textarea name="concepto" class="form-control" rows="3" required 
                                  placeholder="Descripción del concepto de la transacción">${isEdit ? (transaccion.concepto || '') : ''}</textarea>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Número de Comprobante</label>
                        <input type="text" name="numeroComprobante" class="form-control" 
                               value="${isEdit ? (transaccion.numeroComprobante || '') : ''}" 
                               placeholder="Número del comprobante">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Fecha de Transacción</label>
                        <input type="datetime-local" name="fechaTransaccion" class="form-control" 
                               value="${isEdit && transaccion.fechaTransaccion ? new Date(transaccion.fechaTransaccion).toISOString().slice(0, 16) : ''}">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea name="observaciones" class="form-control" rows="2" 
                                  placeholder="Observaciones adicionales">${isEdit ? (transaccion.observaciones || '') : ''}</textarea>
                    </div>
                </div>
            </div>
        </form>
    `;
}

// Funciones de procesamiento
function crearTransaccion() {
    const form = document.getElementById('transaccionForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Convertir campos numéricos
    data.monto = parseFloat(data.monto) || 0;
    if (data.contribuyenteId) {
        data.contribuyenteId = parseInt(data.contribuyenteId);
    } else {
        delete data.contribuyenteId;
    }
    
    // Limpiar campos vacíos
    Object.keys(data).forEach(key => {
        if (data[key] === '') {
            delete data[key];
        }
    });
    
    console.log('Datos a enviar:', data);
    
    showLoading(true);
    fetch('/transacciones/api', {
        method: 'POST',
        headers: getHeaders(),
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            showLoading(false);
            actualizarSinRecargar('Transacción creada exitosamente');
        } else {
            return response.text().then(text => {
                let errorMsg = 'Error al crear la transacción';
                try {
                    const errorObj = JSON.parse(text);
                    errorMsg = errorObj.error || errorObj.message || errorMsg;
                } catch (e) {
                    errorMsg = text || `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMsg);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showLoading(false);
        showToast('Error al crear transacción: ' + error.message, 'error');
    });
}

function actualizarTransaccion(id) {
    const form = document.getElementById('transaccionForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Convertir campos numéricos
    data.monto = parseFloat(data.monto) || 0;
    if (data.contribuyenteId) {
        data.contribuyenteId = parseInt(data.contribuyenteId);
    } else {
        delete data.contribuyenteId;
    }
    
    // Limpiar campos vacíos
    Object.keys(data).forEach(key => {
        if (data[key] === '') {
            delete data[key];
        }
    });
    
    console.log('Datos a actualizar:', data);
    
    showLoading(true);
    fetch(`/transacciones/api/${id}`, {
        method: 'PUT',
        headers: getHeaders(),
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            showLoading(false);
            actualizarSinRecargar('Transacción actualizada exitosamente');
        } else {
            return response.text().then(text => {
                let errorMsg = 'Error al actualizar la transacción';
                try {
                    const errorObj = JSON.parse(text);
                    errorMsg = errorObj.error || errorObj.message || errorMsg;
                } catch (e) {
                    errorMsg = text || `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMsg);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showLoading(false);
        showToast('Error al actualizar transacción: ' + error.message, 'error');
    });
}

// Función para actualizar operaciones sin recargar página
function actualizarSinRecargar(mensaje, callback) {
    showToast(mensaje, 'success');
    closeModal();
    
    // Recargar datos después de un breve delay
    setTimeout(() => {
        recargarTabla();
        if (callback) callback();
    }, 1000);
}

// Función mejorada para cerrar modal
function closeModal() {
    const modal = document.querySelector('.modal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Limpiar formularios
    const forms = document.querySelectorAll('#transaccionForm');
    forms.forEach(form => {
        if (form) form.reset();
    });
    
    // Restaurar botones
    showLoading(false);
}

// Funciones auxiliares para cargar datos
function cargarContribuyentes() {
    // Intentar múltiples endpoints para contribuyentes
    const endpoints = [
        '/api/contribuyentes',
        '/tributario/contribuyentes/api',
        '/contribuyentes/api'
    ];
    
    async function intentarCargar(urls) {
        for (const url of urls) {
            try {
                const response = await fetch(url, {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const contribuyentes = await response.json();
                    return contribuyentes;
                }
            } catch (error) {
                console.log(`Endpoint ${url} no disponible:`, error.message);
            }
        }
        throw new Error('No se pudo conectar con ningún endpoint de contribuyentes');
    }
    
    intentarCargar(endpoints)
    .then(contribuyentes => {
        const select = document.getElementById('editContribuyenteId');
        if (select) {
            // Limpiar opciones existentes (excepto la primera)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Si no hay contribuyentes, agregar opciones de ejemplo
            if (!contribuyentes || contribuyentes.length === 0) {
                const contribuyentesEjemplo = [
                    { id: 1, razonSocial: 'Empresa Ejemplo C.A.', rif: 'J-12345678-9' },
                    { id: 2, razonSocial: 'Comercial Demo S.R.L.', rif: 'J-87654321-0' },
                    { id: 3, razonSocial: 'Juan Pérez', rif: 'V-12345678-9' }
                ];
                contribuyentesEjemplo.forEach(contrib => {
                    const option = document.createElement('option');
                    option.value = contrib.id;
                    option.textContent = `${contrib.razonSocial} (${contrib.rif})`;
                    select.appendChild(option);
                });
                showToast('Usando contribuyentes de ejemplo - Configurar endpoint en producción', 'info');
            } else {
                contribuyentes.forEach(contrib => {
                    const option = document.createElement('option');
                    option.value = contrib.id;
                    option.textContent = `${contrib.razonSocial || contrib.nombre || contrib.denominacion} (${contrib.rif})`;
                    select.appendChild(option);
                });
            }
        }
    })
    .catch(error => {
        console.error('Error al cargar contribuyentes:', error);
        
        // Como fallback, agregar contribuyentes de ejemplo
        const select = document.getElementById('editContribuyenteId');
        if (select) {
            // Limpiar opciones existentes (excepto la primera)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            const contribuyentesEjemplo = [
                { id: 1, razonSocial: 'Sumidistribuciones C.A.', rif: 'J-12345678-9' },
                { id: 2, razonSocial: 'Constructora del Norte C.A.', rif: 'J-20987654-1' },
                { id: 3, razonSocial: 'Juan Carlos Pérez López', rif: 'V-10123456-1' },
                { id: 4, razonSocial: 'Sinumatek Solutions', rif: 'V-17456789-8' }
            ];
            
            contribuyentesEjemplo.forEach(contrib => {
                const option = document.createElement('option');
                option.value = contrib.id;
                option.textContent = `${contrib.razonSocial} (${contrib.rif})`;
                select.appendChild(option);
            });
        }
        
        showToast('Usando contribuyentes de ejemplo - Verificar configuración del servidor', 'info');
    });
}

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página de transacciones cargada correctamente');
    
    // Agregar event listeners para filtros
    const buscarInput = document.getElementById('buscarTransaccion');
    const filtroEstado = document.getElementById('filtroEstado');
    const filtroTipo = document.getElementById('filtroTipo');
    
    if (buscarInput) {
        buscarInput.addEventListener('input', filtrarTransacciones);
    }
    
    if (filtroEstado) {
        filtroEstado.addEventListener('change', filtrarTransacciones);
    }
    
    if (filtroTipo) {
        filtroTipo.addEventListener('change', filtrarTransacciones);
    }
});

// Función para filtrar transacciones en tiempo real
function filtrarTransacciones() {
    const buscar = document.getElementById('buscarTransaccion')?.value.toLowerCase() || '';
    const estado = document.getElementById('filtroEstado')?.value || '';
    const tipo = document.getElementById('filtroTipo')?.value || '';
    
    const filas = document.querySelectorAll('.fullscreen-table tbody tr');
    
    filas.forEach(fila => {
        if (fila.cells.length < 7) return; // Skip empty rows
        
        const numero = fila.cells[0].textContent.toLowerCase();
        const tipoTransaccion = fila.cells[1].textContent;
        const contribuyente = fila.cells[2].textContent.toLowerCase();
        const estadoTransaccion = fila.cells[4].textContent.trim();
        
        const coincideBusqueda = numero.includes(buscar) || contribuyente.includes(buscar);
        const coincideEstado = !estado || estadoTransaccion.includes(estado);
        const coincideTipo = !tipo || tipoTransaccion.includes(tipo);
        
        if (coincideBusqueda && coincideEstado && coincideTipo) {
            fila.style.display = '';
        } else {
            fila.style.display = 'none';
        }
    });
}

/*]]>*/
</script>
</body>
</html>
