<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Pago - Sistema Tributario</title>
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <link rel="stylesheet" th:href="@{/css/fullscreen-layout.css}">
    <link rel="stylesheet" th:href="@{/css/buttons-professional.css}">
    <link rel="stylesheet" th:href="@{/css/icons.css}">
    <script th:src="@{/js/theme.js}"></script>
</head>
<body>
<div class="fullscreen-container">
    <!-- Efectos decorativos -->
    <div class="fullscreen-effects">
        <div class="fullscreen-splash1"></div>
        <div class="fullscreen-splash2"></div>
        <div class="fullscreen-splash3"></div>
    </div>
    
    <!-- Navegación -->
    <aside th:replace="fragments/nav :: body"></aside>
    
    <!-- Contenido principal -->
    <main class="fullscreen-main">
        <!-- Header -->
        <div class="fullscreen-header">
            <h2 style="margin:0;color:#e2e8f0;font-size:24px;font-weight:700;display:flex;align-items:center;gap:12px">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="page-title-icon">
                    <rect x="1" y="3" width="15" height="13"/>
                    <path d="m16 8 2 2-2 2"/>
                    <path d="M21 12H7"/>
                    <path d="M7 8v8"/>
                </svg>
                Detalle de Pago #<span th:text="${pago.id}">1</span>
            </h2>
            <div style="display:flex;align-items:center;gap:16px">
                <button class="btn-modern btn-modern-secondary" onclick="window.location.href='/pagos'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <path d="m12 19-7-7 7-7"/>
                        <path d="M19 12H5"/>
                    </svg>
                    Volver
                </button>
                
                <button th:if="${pago.estado.name() == 'PENDIENTE'}" 
                        class="btn-modern btn-modern-success" 
                        th:onclick="'procesarPago(' + ${pago.id} + ')'"
                        sec:authorize="hasAnyAuthority('PAGOS_WRITE','PAGOS_GESTIONAR')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                    Procesar
                </button>
                
                <button th:if="${pago.estado.name() == 'PROCESADO'}" 
                        class="btn-modern btn-modern-success" 
                        th:onclick="'confirmarPago(' + ${pago.id} + ')'"
                        sec:authorize="hasAnyAuthority('PAGOS_WRITE','PAGOS_GESTIONAR')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22,4 12,14.01 9,11.01"/>
                    </svg>
                    Confirmar
                </button>
                
                <button class="btn-modern btn-modern-export" onclick="imprimirComprobante()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <polyline points="6,9 6,2 18,2 18,9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                    Imprimir
                </button>
            </div>
        </div>

        <!-- Alertas -->
        <div th:if="${success}" class="alert alert-success" style="margin-bottom:20px">
            <span th:text="${success}"></span>
        </div>
        <div th:if="${error}" class="alert alert-danger" style="margin-bottom:20px">
            <span th:text="${error}"></span>
        </div>

        <!-- Información del pago -->
        <div class="grid grid-cols-2 gap-6">
            <!-- Información principal -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Información del Pago</h3>
                </div>
                <div style="padding:24px">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">ID del Pago</label>
                            <div style="font-size:18px;font-weight:600;color:#8b5cf6" th:text="${pago.id}">1</div>
                        </div>
                        
                        <div>
                            <label class="form-label">Estado</label>
                            <div>
                                <span th:class="${'badge ' + (pago.estado.name() == 'CONFIRMADO' ? 'badge-success' : 
                                                            pago.estado.name() == 'PROCESADO' ? 'badge-warning' : 
                                                            pago.estado.name() == 'PENDIENTE' ? 'badge-primary' : 
                                                            'badge-danger')}" 
                                      th:text="${pago.estadoDescripcion}">Estado</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="form-label">Monto</label>
                            <div style="font-size:24px;font-weight:700;color:#10b981" th:text="${#numbers.formatDecimal(pago.monto, 1, 2)}">0.00</div>
                        </div>
                        
                        <div>
                            <label class="form-label">Método de Pago</label>
                            <div style="font-weight:600" th:text="${pago.metodoPagoDescripcion}">Método</div>
                        </div>
                        
                        <div th:if="${pago.referencia}">
                            <label class="form-label">Referencia</label>
                            <div style="font-family:monospace;background:#f8fafc;padding:8px;border-radius:4px" th:text="${pago.referencia}">REF123</div>
                        </div>
                        
                        <div>
                            <label class="form-label">Fecha de Pago</label>
                            <div th:text="${#temporals.format(pago.fechaPago, 'dd/MM/yyyy HH:mm')}">Fecha</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:20px">
                        <label class="form-label">Concepto</label>
                        <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:4px solid #8b5cf6" th:text="${pago.concepto}">
                            Concepto del pago
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del contribuyente -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Contribuyente</h3>
                </div>
                <div style="padding:24px">
                    <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
                        <div style="width:60px;height:60px;background:#8b5cf6;border-radius:50%;display:flex;align-items:center;justify-content:center">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-size:18px;font-weight:600;color:#e2e8f0" th:text="${pago.contribuyenteNombre}">Nombre</div>
                            <div style="color:#64748b" th:text="${pago.contribuyenteRif}">RIF</div>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:12px">
                        <button class="btn btn-sm btn-secondary" th:onclick="'window.location.href=\'/pagos/contribuyente/' + ${pago.contribuyenteId} + '\''">
                            Ver todos los pagos
                        </button>
                        <button class="btn btn-sm btn-secondary" th:onclick="'window.location.href=\'/tributario/contribuyentes/' + ${pago.contribuyenteId} + '\''">
                            Ver contribuyente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información adicional -->
        <div class="card" style="margin-top:24px">
            <div class="card-header">
                <h3 class="card-title">Información Adicional</h3>
            </div>
            <div style="padding:24px">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Fecha de Registro</label>
                        <div th:text="${#temporals.format(pago.creadoEn, 'dd/MM/yyyy HH:mm:ss')}">Fecha</div>
                    </div>
                    
                    <div th:if="${pago.usuarioRegistro}">
                        <label class="form-label">Usuario que Registró</label>
                        <div th:text="${pago.usuarioRegistro}">Usuario</div>
                    </div>
                    
                    <div th:if="${pago.declaracionId}">
                        <label class="form-label">Declaración Asociada</label>
                        <div>
                            <a th:href="@{'/tributario/' + ${pago.declaracionId}}" 
                               style="color:#8b5cf6;text-decoration:none;font-weight:600">
                                Declaración #<span th:text="${pago.declaracionId}">1</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <div th:if="${pago.comprobantePath}" style="margin-top:20px">
                    <label class="form-label">Comprobante</label>
                    <div>
                        <a th:href="${pago.comprobantePath}" target="_blank" class="btn btn-sm btn-secondary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                            Ver Comprobante
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones adicionales -->
        <div th:if="${pago.estado.name() != 'CONFIRMADO'}" class="card" style="margin-top:24px">
            <div class="card-header">
                <h3 class="card-title">Acciones</h3>
            </div>
            <div style="padding:24px;display:flex;gap:12px">
                <button th:if="${pago.estado.name() != 'ANULADO'}" 
                        class="btn btn-danger" 
                        th:onclick="'anularPago(' + ${pago.id} + ')'"
                        sec:authorize="hasAnyAuthority('PAGOS_WRITE','PAGOS_GESTIONAR')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    Anular Pago
                </button>
            </div>
        </div>
    </main>
</div>

<script>
function procesarPago(id) {
    if (confirm('¿Está seguro de procesar este pago?')) {
        fetch('/pagos/api/' + id + '/procesar', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al procesar el pago');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar el pago');
        });
    }
}

function confirmarPago(id) {
    if (confirm('¿Está seguro de confirmar este pago?')) {
        fetch('/pagos/api/' + id + '/confirmar', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al confirmar el pago');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al confirmar el pago');
        });
    }
}

function anularPago(id) {
    if (confirm('¿Está seguro de anular este pago? Esta acción no se puede deshacer.')) {
        fetch('/pagos/api/' + id + '/anular', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al anular el pago');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al anular el pago');
        });
    }
}

function imprimirComprobante() {
    window.print();
}
</script>

<style>
@media print {
    .fullscreen-nav, .fullscreen-header button, .card:last-child {
        display: none !important;
    }
    
    .fullscreen-main {
        margin-left: 0 !important;
    }
    
    .card {
        box-shadow: none !important;
        border: 1px solid #ccc !important;
    }
}
</style>
</body>
</html>
