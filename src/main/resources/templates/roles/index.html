<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Roles y Permisos - Sistema Tributario</title>
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <link rel="stylesheet" th:href="@{/css/fullscreen-layout.css}">
    <link rel="stylesheet" th:href="@{/css/buttons-professional.css}">
    <link rel="stylesheet" th:href="@{/css/icons.css}">
    <script th:src="@{/js/theme.js}"></script>
</head>
<body>
<div class="fullscreen-container">
    <!-- Efectos decorativos -->
    <div class="fullscreen-effects">
        <div class="fullscreen-splash1"></div>
        <div class="fullscreen-splash2"></div>
        <div class="fullscreen-splash3"></div>
    </div>
    
    <!-- Navegaci√≥n -->
    <aside th:replace="fragments/nav :: body"></aside>
    
    <!-- Contenido principal -->
    <main class="fullscreen-main">
        <!-- Header -->
        <div class="fullscreen-header">
            <h2 style="margin:0;color:#e2e8f0;font-size:24px;font-weight:700;display:flex;align-items:center;gap:12px">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="page-title-icon">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <circle cx="12" cy="16" r="1"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                Gesti√≥n de Roles y Permisos
            </h2>
            <div style="display:flex;align-items:center;gap:16px">
                <button class="btn-modern btn-modern-success" sec:authorize="hasAnyAuthority('ROLES_WRITE','ROLES_GESTIONAR')" onclick="openModal('Nuevo Rol', getRolForm(), submitRol)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nuevo Rol
                </button>
            </div>
        </div>
        
        <!-- Contenido con scroll -->
        <div class="fullscreen-content">
            <!-- Estad√≠sticas r√°pidas -->
            <div class="fullscreen-stats">
                <div class="stat-card" style="border-left:4px solid #8b5cf6">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Total Roles</div>
                    <div style="font-size:32px;font-weight:700;color:#8b5cf6" th:text="${#lists.size(roles)}">0</div>
                </div>
                
                <div class="stat-card" style="border-left:4px solid #10b981">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Roles Activos</div>
                    <div style="font-size:32px;font-weight:700;color:#10b981" th:text="${rolesActivos}">0</div>
                </div>
                
                <div class="stat-card" style="border-left:4px solid #f59e0b">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Permisos √önicos</div>
                    <div style="font-size:32px;font-weight:700;color:#f59e0b" th:text="${permisosUnicos}">0</div>
                </div>
            </div>

            <!-- Tabla de roles -->
            <div class="fullscreen-table-container">
                <div style="padding:20px;border-bottom:1px solid rgba(148, 163, 184, 0.2)">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:#e2e8f0;font-size:18px;font-weight:600">üìã Lista de Roles</h3>
                        <div style="display:flex;gap:12px;align-items:center">
                            <input type="text" placeholder="Buscar rol..." class="form-control" style="width:200px;background:rgba(15, 23, 42, 0.6);border:1px solid rgba(148, 163, 184, 0.3);color:#e2e8f0" id="searchInput">
                        </div>
                    </div>
                </div>
                
                <div style="overflow-y:auto;max-height:calc(100vh - 320px)">
                    <table class="fullscreen-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                                <th>Usuarios Asignados</th>
                                <th>Permisos</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="rolesTable">
                            <tr th:each="r: ${roles}">
                                <td>
                                    <div style="font-weight:500" th:text="${r.nombre}"></div>
                                </td>
                                <td th:text="${r.descripcion}"></td>
                                <td>
                                    <span class="badge badge-primary">0 usuarios</span>
                                </td>
                                <td>
                                    <span class="badge badge-secondary" th:text="${#lists.size(r.permisos)} + ' permisos'">0 permisos</span>
                                </td>
                                <td>
                                    <span class="badge badge-success">Activo</span>
                                </td>
                                <td>
                                    <div style="display:flex;gap:8px">
                                        <!-- Ver rol - disponible para todos los que tienen acceso a roles -->
                                        <button class="btn btn-sm btn-secondary" 
                                                th:onclick="'verRol(' + ${r.id} + ')'">
                                            üëÅÔ∏è
                                        </button>
                                        
                                        <!-- Editar rol - solo para usuarios con permisos de escritura -->
                                        <button class="btn btn-sm btn-primary" 
                                                sec:authorize="hasAnyAuthority('ROLES_WRITE','ROLES_GESTIONAR')"
                                                th:onclick="'editarRol(' + ${r.id} + ')'">
                                            ‚úèÔ∏è
                                        </button>
                                        
                                        <!-- Gestionar permisos - solo para usuarios con permisos de gesti√≥n -->
                                        <button class="btn btn-sm btn-warning" 
                                                sec:authorize="hasAnyAuthority('ROLES_GESTIONAR')"
                                                th:onclick="'gestionarPermisosRol(' + ${r.id} + ')'">
                                            üîê
                                        </button>
                                        
                                        <!-- Eliminar rol - solo para usuarios con permisos de eliminaci√≥n -->
                                        <button class="btn btn-sm btn-danger" 
                                                sec:authorize="hasAnyAuthority('ROLES_DELETE','ROLES_GESTIONAR')"
                                                th:onclick="'eliminarRol(' + ${r.id} + ')'">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(roles)}">
                                <td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted)">
                                    üë• No hay roles registrados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modales integrados -->
    <div id="modalBase" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px)">
        <div class="modal-content" style="background:#1e1e2a;margin:5% auto;padding:0;border-radius:12px;width:90%;max-width:500px;box-shadow:0 20px 40px rgba(0,0,0,0.3);border:1px solid #2a2a3a">
            <div class="modal-header" style="padding:16px 20px;border-bottom:1px solid #2a2a3a;display:flex;align-items:center;justify-content:space-between">
                <h3 class="modal-title" style="margin:0;font-size:18px;font-weight:600;color:#e7e7f7">T√≠tulo del Modal</h3>
                <button class="modal-close" onclick="closeModal()" style="background:none;border:none;color:#a4a4be;font-size:20px;cursor:pointer;padding:0;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center">
                    &times;
                </button>
            </div>
            <div class="modal-body" style="padding:20px">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer" style="padding:16px 20px;border-top:1px solid #2a2a3a;display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()" style="padding:8px 16px;border-radius:6px;border:1px solid #3a3a4a;background:transparent;color:#a4a4be;cursor:pointer;font-size:14px">
                    Cancelar
                </button>
                <button class="btn-primary modal-submit" style="padding:8px 20px;border-radius:6px;border:none;background:#6366f1;color:white;cursor:pointer;font-size:14px;font-weight:500">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="confirmModal" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px)">
        <div class="modal-content" style="background:#1e1e2a;margin:15% auto;padding:0;border-radius:12px;width:90%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,0.3);border:1px solid #2a2a3a">
            <div class="modal-body" style="padding:24px;text-align:center">
                <div style="font-size:48px;color:#ef4444;margin-bottom:16px">‚ö†Ô∏è</div>
                <h3 style="margin:0 0 12px 0;font-size:18px;font-weight:600;color:#e7e7f7">¬øEst√° seguro?</h3>
                <p style="margin:0;color:#a4a4be;line-height:1.5">Esta acci√≥n no se puede deshacer.</p>
            </div>
            <div class="modal-footer" style="padding:16px 24px;border-top:1px solid #2a2a3a;display:flex;gap:12px;justify-content:center">
                <button class="btn-secondary" onclick="closeConfirmModal()" style="padding:8px 20px;border-radius:6px;border:1px solid #3a3a4a;background:transparent;color:#a4a4be;cursor:pointer;font-size:14px">
                    Cancelar
                </button>
                <button id="confirmAction" class="btn-danger" style="padding:8px 20px;border-radius:6px;border:none;background:#ef4444;color:white;cursor:pointer;font-size:14px;font-weight:500">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="brand">Sistema Tributario Empresarial v2.0</div>
    <div class="splash"></div><div class="splash2"></div><div class="splash3"></div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    
    // Lista de permisos disponibles desde el servidor
    const permisosDisponibles = /*[[${permisos}]]*/ [];
    
    // Funci√≥n espec√≠fica para abrir modal de nuevo rol
    function abrirModalNuevoRol() {
        try {
            const formulario = getRolForm();
            openModal('Nuevo Rol', formulario, submitRol);
        } catch (error) {
            console.error('Error al abrir modal:', error);
            showToast('Error al abrir formulario', 'error');
        }
    }
    
    // Funci√≥n espec√≠fica para gesti√≥n de permisos
    function abrirGestionPermisos() {
        try {
            gestionarPermisos();
        } catch (error) {
            console.error('Error al gestionar permisos:', error);
            showToast('Error al abrir gesti√≥n de permisos', 'error');
        }
    }
    
    // Funciones de modal
    function openModal(title, content, onSubmit) {
        const modal = document.getElementById('modalBase');
        const modalTitle = modal.querySelector('.modal-title');
        const modalBody = modal.querySelector('.modal-body');
        const modalFooter = modal.querySelector('.modal-footer');
        
        modalTitle.innerHTML = title;
        modalBody.innerHTML = content;
        
        // Limpiar botones existentes
        modalFooter.innerHTML = '';
        
        // Agregar bot√≥n de cancelar
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary';
        cancelBtn.textContent = 'Cerrar';
        cancelBtn.onclick = closeModal;
        modalFooter.appendChild(cancelBtn);
        
        // Agregar bot√≥n de enviar si se proporciona
        if (onSubmit) {
            const submitBtn = document.createElement('button');
            submitBtn.className = 'btn btn-primary ms-2';
            submitBtn.textContent = 'Guardar';
            submitBtn.onclick = onSubmit;
            modalFooter.appendChild(submitBtn);
        }
        
        // Mostrar modal
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
        const modal = document.getElementById('modalBase');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    function openConfirmModal(message, onConfirm) {
        const modal = document.getElementById('confirmModal');
        if (!modal) {
            console.error('Modal de confirmaci√≥n no encontrado');
            return;
        }
        
        if (message) {
            modal.querySelector('p').textContent = message;
        }
        
        const confirmBtn = document.getElementById('confirmAction');
        confirmBtn.onclick = function() {
            if (onConfirm && typeof onConfirm === 'function') {
                onConfirm();
            }
            closeConfirmModal();
        };
        
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
    
    function closeConfirmModal() {
        const modal = document.getElementById('confirmModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    // Funci√≥n para obtener formulario de nuevo rol
    function getRolForm(rol = null) {
        try {
            const isEdit = rol !== null;
            
            return `
                <form id="rolForm">
                    ${isEdit ? `<input type="hidden" name="id" value="${rol ? rol.id : ''}">` : ''}
                    <div class="form-group">
                        <label class="form-label">Nombre del Rol *</label>
                        <input type="text" class="form-control" name="nombre" 
                               value="${isEdit && rol ? rol.nombre || '' : ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n *</label>
                        <textarea class="form-control" name="descripcion" rows="3" required>${isEdit && rol ? rol.descripcion || '' : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                            <input type="checkbox" name="activo" ${isEdit && rol ? (rol.activo ? 'checked' : '') : 'checked'}>
                            <span>Rol activo</span>
                        </label>
                    </div>
                </form>
            `;
        } catch (error) {
            console.error('Error en getRolForm:', error);
            return '<p class="text-danger">Error generando formulario</p>';
        }
    }
    
    // Funci√≥n para generar checkboxes de permisos
    function getPermisosCheckboxes(permisosAsignados = []) {
        if (!permisosDisponibles || permisosDisponibles.length === 0) {
            return '<p class="text-secondary">No hay permisos disponibles</p>';
        }
        
        // Agrupar permisos por m√≥dulo basado en el prefijo de la clave
        const modulosMap = {};
        permisosDisponibles.forEach(permiso => {
            let modulo = 'General';
            if (permiso.clave) {
                if (permiso.clave.includes('DECLARACIONES') || permiso.clave.includes('CONTRIBUYENTES') || 
                    permiso.clave.includes('IMPUESTOS') || permiso.clave.includes('RETENCIONES') || 
                    permiso.clave.includes('COMPROBANTES')) {
                    modulo = 'Tributario';
                } else if (permiso.clave.includes('USUARIOS') || permiso.clave.includes('ROLES') || 
                          permiso.clave.includes('CONFIGURACION')) {
                    modulo = 'Administraci√≥n';
                } else if (permiso.clave.includes('REPORTES')) {
                    modulo = 'Reportes';
                }
            }
            
            if (!modulosMap[modulo]) {
                modulosMap[modulo] = [];
            }
            modulosMap[modulo].push(permiso);
        });
        
        let html = '';
        Object.keys(modulosMap).forEach(modulo => {
            html += `<div style="margin-bottom:16px">`;
            html += `<h4 style="margin:0 0 8px 0;font-size:14px;color:var(--primary)">${modulo}</h4>`;
            
            modulosMap[modulo].forEach(permiso => {
                const isChecked = permisosAsignados.some(p => p.id === permiso.id);
                html += `
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:4px;cursor:pointer">
                        <input type="checkbox" name="permisos" value="${permiso.id}" ${isChecked ? 'checked' : ''}>
                        <span style="font-size:13px">${permiso.nombre || 'Sin nombre'}</span>
                    </label>
                `;
            });
            html += `</div>`;
        });
        
        return html;
    }
    
    // Funci√≥n para enviar nuevo/editar rol
    function submitRol() {
        const form = document.getElementById('rolForm');
        const formData = new FormData(form);
        
        // Convertir FormData a JSON
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'permisos') {
                if (!data.permisos) data.permisos = [];
                data.permisos.push(parseInt(value));
            } else if (value) {  
                data[key] = value;
            }
        });
        
        const isEdit = data.id;
        const url = isEdit ? `/roles/${data.id}` : '/roles';
        const method = isEdit ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '[[${_csrf.token}]]'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast(result.message, 'success');
                closeModal();
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error de conexi√≥n: ' + error.message, 'error');
        });
    }
    
    // Funci√≥n para actualizar la fila en la tabla
    function actualizarFilaTabla(rol) {
        let fila = document.querySelector(`tr[data-rol-id="${rol.id}"]`);
        
        if (!fila) {
            // Si la fila no existe, la creamos al principio de la tabla
            const tbody = document.querySelector('#rolesTable');
            const nuevaFila = document.createElement('tr');
            nuevaFila.setAttribute('data-rol-id', rol.id);
            nuevaFila.innerHTML = `
                <td><div style="font-weight:500">${rol.nombre || 'Sin nombre'}</div></td>
                <td>${rol.descripcion || ''}</td>
                <td><span class="badge badge-primary">0 usuarios</span></td>
                <td><span class="badge badge-secondary">${rol.permisos || 0} permisos</span></td>
                <td><span class="badge badge-success">Activo</span></td>
                <td>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-sm btn-secondary" onclick="verRol(${rol.id})">üëÅÔ∏è</button>
                        <button class="btn btn-sm btn-primary" onclick="editarRol(${rol.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-warning" onclick="gestionarPermisosRol(${rol.id})">üîê</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarRol(${rol.id})">üóëÔ∏è</button>
                    </div>
                </td>`;
            tbody.insertBefore(nuevaFila, tbody.firstChild);
        } else {
            // Actualizar la fila existente
            fila.querySelector('td:first-child div').textContent = rol.nombre || 'Sin nombre';
            fila.querySelector('td:nth-child(2)').textContent = rol.descripcion || '';
            fila.querySelector('td:nth-child(4) .badge').textContent = `${rol.permisos || 0} permisos`;
        }
    }
    
    // Funci√≥n para ver detalles del rol
    function verRol(id) {
        fetch(`/roles/${id}`, {
            headers: {
                'X-CSRF-TOKEN': '[[${_csrf.token}]]'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const rol = result.rol;
                const detalles = `
                    <div style="display:grid;gap:16px">
                        <div class="grid grid-cols-2" style="gap:16px">
                            <div>
                                <strong>Nombre del Rol:</strong><br>
                                <span style="font-size:18px;font-weight:600">${rol.nombre}</span>
                            </div>
                            <div>
                                <strong>Estado:</strong><br>
                                <span class="badge badge-success">‚úÖ Activo</span>
                            </div>
                        </div>
                        
                        <div>
                            <strong>Descripci√≥n:</strong><br>
                            <span>${rol.descripcion}</span>
                        </div>
                        
                        <div class="grid grid-cols-2" style="gap:16px">
                            <div>
                                <strong>Total de Permisos:</strong><br>
                                <span style="font-size:16px;font-weight:600;color:var(--primary)">${rol.permisos.length}</span>
                            </div>
                            <div>
                                <strong>Fecha de Creaci√≥n:</strong><br>
                                <span>${new Date().toLocaleDateString('es-ES')}</span>
                            </div>
                        </div>
                        
                        <div>
                            <strong>Permisos Asignados:</strong><br>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
                                ${rol.permisos.map(p => `<span class="badge badge-primary">${p.nombre}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                openModal('üëÅÔ∏è Ver Rol', detalles);
            } else {
                showToast('Error al cargar datos del rol', 'error');
            }
        })
        .catch(error => {
            showToast('Error de conexi√≥n', 'error');
        });
    }
    
    // Funci√≥n para editar rol
    function editarRol(id) {
        fetch(`/roles/${id}`, {
            headers: {
                'X-CSRF-TOKEN': '[[${_csrf.token}]]'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const rol = result.rol;
                openModal('‚úèÔ∏è Editar Rol', getRolForm(rol), submitRol);
            } else {
                showToast('Error al cargar datos del rol', 'error');
            }
        })
        .catch(error => {
            showToast('Error de conexi√≥n', 'error');
        });
    }
    
    // Funci√≥n para gestionar permisos de un rol espec√≠fico
    function gestionarPermisosRol(id) {
        // Cargar datos del rol
        fetch(`/roles/${id}`, {
            headers: {
                'X-CSRF-TOKEN': '[[${_csrf.token}]]'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const rol = result.rol;
                const permisosForm = `
                    <form id="permisosForm">
                        <input type="hidden" name="rolId" value="${id}">
                        <div style="margin-bottom:16px">
                            <strong>Gestionar permisos para: ${rol.nombre || 'Rol sin nombre'}</strong>
                            <p class="text-secondary" style="margin:4px 0 0 0">${rol.descripcion || ''}</p>
                        </div>
                        <div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;padding:12px">
                            ${getPermisosCheckboxes(rol.permisos || [])}
                        </div>
                    </form>
                `;
                
                openModal('üîê Gestionar Permisos', permisosForm, function() {
                    submitPermisosRol();
                });
            } else {
                showToast('Error al cargar datos del rol', 'error');
            }
        })
        .catch(error => {
            showToast('Error de conexi√≥n', 'error');
        });
    }
    
    // Funci√≥n para enviar permisos actualizados del rol
    function submitPermisosRol() {
        const form = document.getElementById('permisosForm');
        const formData = new FormData(form);
        
        const rolId = formData.get('rolId');
        const permisos = [];
        
        // Obtener todos los permisos seleccionados
        const checkboxes = form.querySelectorAll('input[name="permisos"]:checked');
        checkboxes.forEach(checkbox => {
            permisos.push(parseInt(checkbox.value));
        });
        
        const data = {
            permisos: permisos
        };
        
        fetch(`/roles/${rolId}/permisos`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '[[${_csrf.token}]]'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast('Permisos actualizados exitosamente', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.message || 'Error al actualizar permisos', 'error');
            }
        })
        .catch(error => {
            showToast('Error de conexi√≥n: ' + error.message, 'error');
        });
    }
    
    // Funci√≥n para gesti√≥n general de permisos
    function gestionarPermisos() {
        let permisosTabla = '';
        
        if (permisosDisponibles && Array.isArray(permisosDisponibles) && permisosDisponibles.length > 0) {
            permisosTabla = permisosDisponibles.map(p => {
                let modulo = 'General';
                if (p.clave) {
                    if (p.clave.includes('DECLARACIONES') || p.clave.includes('CONTRIBUYENTES') || 
                        p.clave.includes('IMPUESTOS') || p.clave.includes('RETENCIONES') || 
                        p.clave.includes('COMPROBANTES')) {
                        modulo = 'Tributario';
                    } else if (p.clave.includes('USUARIOS') || p.clave.includes('ROLES') || 
                              p.clave.includes('CONFIGURACION')) {
                        modulo = 'Administraci√≥n';
                    } else if (p.clave.includes('REPORTES')) {
                        modulo = 'Reportes';
                    }
                }
                
                return `
                    <tr>
                        <td>${p.nombre || 'Sin nombre'}</td>
                        <td><span class="badge badge-secondary">${modulo}</span></td>
                        <td>0 roles</td>
                    </tr>
                `;
            }).join('');
        } else {
            permisosTabla = '<tr><td colspan="3" style="text-align:center;padding:20px">No hay permisos disponibles</td></tr>';
        }
        
        const permisosGenerales = `
            <div style="display:grid;gap:16px">
                <div>
                    <h4>Permisos del Sistema</h4>
                    <p class="text-secondary">Gestiona los permisos disponibles en el sistema</p>
                </div>
                
                <div style="max-height:300px;overflow-y:auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Permiso</th>
                                <th>M√≥dulo</th>
                                <th>Roles Asignados</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${permisosTabla}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        openModal('üîê Gesti√≥n de Permisos', permisosGenerales, null);
        const submitBtn = document.querySelector('.modal-submit');
        if (submitBtn) {
            submitBtn.style.display = 'none';
        }
    }
    
    // Funci√≥n para eliminar rol
    function eliminarRol(id) {
        openConfirmModal('¬øEst√° seguro de eliminar este rol? Los usuarios asignados perder√°n estos permisos.', function() {
            fetch(`/roles/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': '[[${_csrf.token}]]'
                }
            })
            .then(response => {
                if (response.ok) {
                    showToast('Rol eliminado exitosamente', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('Error al eliminar el rol', 'error');
                }
            })
            .catch(error => {
                showToast('Error de conexi√≥n', 'error');
            });
        });
    }
    
    // Funci√≥n para mostrar notificaciones toast
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
        toast.innerHTML = `
            <span style="font-size:16px">${icon}</span>
            <span>${message}</span>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 4000);
    }
    
    // Filtros y b√∫squeda
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const table = document.getElementById('rolesTable');
        
        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                if (row.cells.length === 1) return;
                
                const nombre = row.cells[0].textContent.toLowerCase();
                const descripcion = row.cells[1].textContent.toLowerCase();
                
                const matchesSearch = nombre.includes(searchTerm) || descripcion.includes(searchTerm);
                
                row.style.display = matchesSearch ? '' : 'none';
            });
        }
        
        searchInput.addEventListener('input', filterTable);
    });
    
    /*]]>*/
</script>
</body>
</html>

