<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Gesti√≥n de Impuestos - Sistema Tributario</title>
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <link rel="stylesheet" th:href="@{/css/fullscreen-layout.css}">
    <link rel="stylesheet" th:href="@{/css/buttons-professional.css}">
    <link rel="stylesheet" th:href="@{/css/icons.css}">
    <script th:src="@{/js/theme.js}"></script>
</head>
<body>
<div class="fullscreen-container">
    <!-- Efectos decorativos -->
    <div class="fullscreen-effects">
        <div class="fullscreen-splash1"></div>
        <div class="fullscreen-splash2"></div>
        <div class="fullscreen-splash3"></div>
    </div>
    
    <!-- Navegaci√≥n -->
    <aside th:replace="fragments/nav :: body"></aside>
    
    <!-- Contenido principal -->
    <main class="fullscreen-main">
        <!-- Header -->
        <div class="fullscreen-header">
            <h2 style="margin:0;color:#e2e8f0;font-size:24px;font-weight:700;display:flex;align-items:center;gap:12px">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="page-title-icon">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                Gesti√≥n de Impuestos
            </h2>
            <div style="display:flex;align-items:center;gap:16px">
                <button class="btn-modern btn-modern-success" sec:authorize="hasAnyAuthority('IMPUESTOS_WRITE','IMPUESTOS_GESTIONAR')" onclick="openModal('Nuevo Impuesto', getImpuestoForm(), submitImpuesto)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nuevo Impuesto
                </button>
                <button class="btn-modern btn-modern-export" onclick="exportarImpuestos()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exportar
                </button>
            </div>
        </div>
        
        <!-- Contenido con scroll -->
        <div class="fullscreen-content">
            <!-- Estad√≠sticas r√°pidas -->
            <div class="fullscreen-stats">
                <div class="stat-card" style="border-left:4px solid #8b5cf6">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Total Impuestos</div>
                    <div style="font-size:32px;font-weight:700;color:#8b5cf6" th:text="${estadisticas.total}">0</div>
                </div>
                
                <div class="stat-card" style="border-left:4px solid #10b981">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Activos</div>
                    <div style="font-size:32px;font-weight:700;color:#10b981" th:text="${estadisticas.activos}">0</div>
                </div>
                
                <div class="stat-card" style="border-left:4px solid #f59e0b">
                    <div style="font-size:14px;margin-bottom:8px;color:#94a3b8">Tasa Promedio</div>
                    <div style="font-size:32px;font-weight:700;color:#f59e0b" th:text="${#numbers.formatDecimal(estadisticas.tasaPromedio, 1, 2)} + ' %'">0%</div>
                </div>
            </div>

            <!-- Tabla de impuestos -->
            <div class="fullscreen-table-container">
                <div style="padding:20px;border-bottom:1px solid rgba(148, 163, 184, 0.2)">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:#e2e8f0;font-size:18px;font-weight:600">üìã Lista de Impuestos</h3>
                        <div style="display:flex;gap:12px;align-items:center">
                            <input type="text" placeholder="Buscar impuesto..." class="form-control" style="width:200px;background:rgba(15, 23, 42, 0.6);border:1px solid rgba(148, 163, 184, 0.3);color:#e2e8f0" id="searchInput">
                            <select class="form-select" style="width:150px;background:rgba(15, 23, 42, 0.6);border:1px solid rgba(148, 163, 184, 0.3);color:#e2e8f0" id="filterTipo">
                                <option value="">Todos los tipos</option>
                                <option value="DIRECTO">Directo</option>
                                <option value="INDIRECTO">Indirecto</option>
                                <option value="MUNICIPAL">Municipal</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="overflow-y:auto;max-height:calc(100vh - 320px)">
                    <table class="fullscreen-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>C√≥digo</th>
                                <th>Tasa (%)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="impuestosTable">
                            <tr th:each="i: ${impuestos}">
                                <td>
                                    <div style="font-weight:500" th:text="${i.nombre}"></div>
                                </td>
                                <td th:text="${i.codigo}"></td>
                                <td th:text="${#numbers.formatDecimal(i.tasa, 1, 2)} + ' %'"></td>
                                <td>
                                    <div style="display:flex;gap:8px">
                                        <!-- Ver impuesto - disponible para todos -->
                                        <button class="btn btn-sm btn-info" 
                                                th:onclick="'verImpuesto(' + ${i.id} + ')'">
                                            üëÅÔ∏è
                                        </button>
                                        
                                        <!-- Editar impuesto - solo para usuarios con permisos de escritura -->
                                        <button class="btn btn-sm btn-secondary" 
                                                sec:authorize="hasAnyAuthority('IMPUESTOS_WRITE','IMPUESTOS_GESTIONAR')"
                                                th:onclick="'editarImpuesto(' + ${i.id} + ')'">
                                            ‚úèÔ∏è
                                        </button>
                                        
                                        <!-- Eliminar impuesto - solo para usuarios con permisos de eliminaci√≥n -->
                                        <button class="btn btn-sm btn-danger" 
                                                sec:authorize="hasAnyAuthority('IMPUESTOS_DELETE','IMPUESTOS_GESTIONAR')"
                                                th:onclick="'eliminarImpuesto(' + ${i.id} + ')'">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(impuestos)}">
                                <td colspan="4" style="text-align:center;padding:40px;color:var(--text-muted)">
                                    üí∞ No hay impuestos registrados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Incluir modales -->
<div th:replace="fragments/modals :: body"></div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    
    // Funci√≥n para obtener formulario de nuevo impuesto
    function getImpuestoForm(impuesto = null) {
        const isEdit = impuesto !== null;
        
        return `
            <form id="impuestoForm">
                ${isEdit ? `<input type="hidden" name="id" value="${impuesto.id}">` : ''}
                <div class="form-group">
                    <label class="form-label">Nombre del Impuesto *</label>
                    <input type="text" class="form-control" name="nombre" 
                           value="${isEdit ? impuesto.nombre : ''}" 
                           placeholder="Ej: Impuesto General a las Ventas" required>
                </div>
                
                <div class="grid grid-cols-2" style="gap:16px">
                    <div class="form-group">
                        <label class="form-label">C√≥digo *</label>
                        <input type="text" class="form-control" name="codigo" 
                               value="${isEdit ? impuesto.codigo : ''}" 
                               placeholder="Ej: IGV" 
                               style="text-transform:uppercase" maxlength="10" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tasa (%) *</label>
                        <input type="number" step="0.0001" min="0" max="100" class="form-control" name="tasa" 
                               value="${isEdit ? impuesto.tasa : ''}" 
                               placeholder="Ej: 18.0000" required>
                    </div>
                </div>
            </form>
        `;
    }
    
    // Funci√≥n para enviar nuevo/editar impuesto
    function submitImpuesto() {
        const form = document.getElementById('impuestoForm');
        
        // Validaciones del lado del cliente
        const codigo = form.querySelector('input[name="codigo"]').value.trim();
        const nombre = form.querySelector('input[name="nombre"]').value.trim();
        const tasa = parseFloat(form.querySelector('input[name="tasa"]').value);
        
        // Validar c√≥digo
        if (!codigo) {
            showToast('El c√≥digo es obligatorio', 'error');
            return;
        }
        
        // Validar nombre
        if (!nombre) {
            showToast('El nombre es obligatorio', 'error');
            return;
        }
        
        // Validar tasa
        if (isNaN(tasa) || tasa < 0 || tasa > 100) {
            showToast('La tasa debe estar entre 0% y 100%', 'error');
            return;
        }
        
        const formData = new FormData(form);
        
        // Agregar token CSRF
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        formData.append('_csrf', csrfToken);
        
        const isEdit = formData.get('id');
        const url = isEdit ? `/tributario/impuestos/${isEdit}` : '/tributario/impuestos';
        const method = isEdit ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            body: formData
        })
        .then(response => {
            if (response.ok) {
                showToast(isEdit ? 'Impuesto actualizado exitosamente' : 'Impuesto creado exitosamente', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                return response.text().then(text => {
                    throw new Error(text || 'Error en la operaci√≥n');
                });
            }
        })
        .catch(error => {
            showToast('Error: ' + error.message, 'error');
        });
    }
    
    // Funci√≥n para ver detalles del impuesto
    function verImpuesto(id) {
        fetch(`/tributario/impuestos/${id}`)
        .then(response => response.json())
        .then(impuesto => {
            const detalles = `
                <div style="display:grid;gap:16px">
                    <div class="grid grid-cols-2" style="gap:16px">
                        <div>
                            <strong>Nombre:</strong><br>
                            <span>${impuesto.nombre}</span>
                        </div>
                        <div>
                            <strong>C√≥digo:</strong><br>
                            <span>${impuesto.codigo}</span>
                        </div>
                    </div>
                    
                    ${impuesto.descripcion ? `
                        <div>
                            <strong>Descripci√≥n:</strong><br>
                            <span>${impuesto.descripcion}</span>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2" style="gap:16px">
                        <div>
                            <strong>Tipo:</strong><br>
                            <span class="badge ${impuesto.tipo === 'DIRECTO' ? 'badge-primary' : (impuesto.tipo === 'INDIRECTO' ? 'badge-success' : 'badge-warning')}">${impuesto.tipo}</span>
                        </div>
                        <div>
                            <strong>Tasa:</strong><br>
                            <span style="font-size:18px;font-weight:600;color:var(--primary)">${impuesto.tasa}%</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2" style="gap:16px">
                        <div>
                            <strong>Periodicidad:</strong><br>
                            <span>${impuesto.periodicidad}</span>
                        </div>
                        <div>
                            <strong>Base M√≠nima:</strong><br>
                            <span>${impuesto.baseMinima ? '$' + impuesto.baseMinima : 'No especificada'}</span>
                        </div>
                    </div>
                    
                    <div>
                        <strong>Fecha de Vigencia:</strong><br>
                        <span>${new Date(impuesto.fechaVigencia).toLocaleDateString('es-ES')}</span>
                    </div>
                    
                    ${impuesto.observaciones ? `
                        <div>
                            <strong>Observaciones:</strong><br>
                            <span>${impuesto.observaciones}</span>
                        </div>
                    ` : ''}
                    
                    <div>
                        <strong>Estado:</strong><br>
                        <span class="badge ${impuesto.activo ? 'badge-success' : 'badge-danger'}">
                            ${impuesto.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </div>
                </div>
            `;
            
            openModal('üëÅÔ∏è Detalles del Impuesto', detalles, null);
            // Ocultar bot√≥n de guardar para vista de solo lectura
            document.querySelector('.modal-submit').style.display = 'none';
        })
        .catch(error => {
            showToast('Error al cargar los detalles', 'error');
        });
    }
    
    // Funci√≥n para editar impuesto
    function editarImpuesto(id) {
        fetch(`/tributario/impuestos/${id}`)
        .then(response => response.json())
        .then(impuesto => {
            openModal('‚úèÔ∏è Editar Impuesto', getImpuestoForm(impuesto), submitImpuesto);
        })
        .catch(error => {
            showToast('Error al cargar los datos del impuesto', 'error');
        });
    }
    
    // Funci√≥n para cambiar estado del impuesto
    function cambiarEstado(id, estadoActual) {
        const nuevoEstado = !estadoActual;
        const mensaje = nuevoEstado ? 'activar' : 'desactivar';
        
        openConfirmModal(`¬øEst√° seguro de ${mensaje} este impuesto?`, function() {
            fetch(`/tributario/impuestos/${id}/estado`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': '[[${_csrf.token}]]'
                },
                body: JSON.stringify({ activo: nuevoEstado })
            })
            .then(response => {
                if (response.ok) {
                    showToast(`Impuesto ${nuevoEstado ? 'activado' : 'desactivado'} exitosamente`, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('Error al cambiar el estado', 'error');
                }
            })
            .catch(error => {
                showToast('Error de conexi√≥n', 'error');
            });
        });
    }
    
    // Funci√≥n para eliminar impuesto
    function eliminarImpuesto(id) {
        openConfirmModal('¬øEst√° seguro de eliminar este impuesto? Esta acci√≥n no se puede deshacer y eliminar√° todas las declaraciones asociadas.', function() {
            fetch(`/tributario/impuestos/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': '[[${_csrf.token}]]'
                }
            })
            .then(response => {
                if (response.ok) {
                    showToast('Impuesto eliminado exitosamente', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    return response.text().then(text => {
                        showToast('Error: ' + text, 'error');
                    });
                }
            })
            .catch(error => {
                showToast('Error de conexi√≥n', 'error');
            });
        });
    }
    
    // Funci√≥n para exportar impuestos
    function exportarImpuestos() {
        window.open('/tributario/impuestos/export', '_blank');
        showToast('Iniciando descarga...', 'success');
    }
    
    // Funci√≥n para mostrar notificaciones toast
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
        toast.innerHTML = `
            <span style="font-size:16px">${icon}</span>
            <span>${message}</span>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 4000);
    }
    
    // Filtros y b√∫squeda
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const filterTipo = document.getElementById('filterTipo');
        const table = document.getElementById('impuestosTable');
        
        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const tipoFilter = filterTipo.value;
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                if (row.cells.length === 1) return; // Skip empty row
                
                const nombre = row.cells[0].textContent.toLowerCase();
                const codigo = row.cells[1].textContent.toLowerCase();
                const tasa = row.cells[2].textContent;
                
                const matchesSearch = nombre.includes(searchTerm) || codigo.includes(searchTerm);
                const matchesTipo = !tipoFilter;
                
                row.style.display = matchesSearch && matchesTipo ? '' : 'none';
            });
        }
        
        searchInput.addEventListener('input', filterTable);
        filterTipo.addEventListener('change', filterTable);
        
        // Convertir c√≥digo a may√∫sculas mientras se escribe
        document.addEventListener('input', function(e) {
            if (e.target.name === 'codigo') {
                e.target.value = e.target.value.toUpperCase();
            }
        });
    });
    
    /*]]>*/
</script>
</body>
</html>
